<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub PR Explorer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
{% raw %}
    <div id="app">
        <header class="app-header">
            <div class="header-content">
                <h1 class="logo">
                    <span class="logo-icon">
                        <svg viewBox="0 0 16 16" width="24" height="24" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                    </span>
                    PR Explorer
                </h1>
                <div class="header-actions">
                    <button class="queue-toggle" @click="toggleQueuePanel" title="Merge Queue">
                        <svg viewBox="0 0 16 16" width="18" height="18" fill="currentColor">
                            <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"/>
                        </svg>
                        <span class="queue-badge" v-if="mergeQueue.length > 0">{{ mergeQueue.length }}</span>
                    </button>
                    <button class="history-toggle" @click="showHistoryPanel = true; fetchReviewHistory()" title="Review History">
                        <svg viewBox="0 0 16 16" width="18" height="18" fill="currentColor">
                            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm7-3.25v2.992l2.028.812a.75.75 0 0 1-.557 1.392l-2.5-1A.751.751 0 0 1 7 8.25v-3.5a.75.75 0 0 1 1.5 0Z"/>
                        </svg>
                        <span class="history-badge" v-if="reviewHistory.length > 0">{{ reviewHistory.length }}</span>
                    </button>
                    <button class="theme-toggle" @click="toggleTheme" :title="darkMode ? 'Switch to light mode' : 'Switch to dark mode'">
                        <span v-if="darkMode">&#9788;</span>
                        <span v-else>&#9790;</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="app-main">
            <!-- Account/Organization Selector -->
            <section class="account-selector">
                <div class="selector-wrapper">
                    <label>Account / Organization</label>
                    <div class="account-buttons" v-if="!accountsLoading">
                        <button
                            v-for="account in accounts"
                            :key="account.login"
                            class="account-btn"
                            :class="{ active: selectedAccount?.login === account.login }"
                            @click="selectAccount(account)"
                        >
                            <img v-if="account.avatar_url" :src="account.avatar_url" :alt="account.login" class="account-avatar">
                            <span class="account-name">{{ account.login }}</span>
                            <span class="account-type">{{ account.is_personal ? 'Personal' : 'Org' }}</span>
                        </button>
                    </div>
                    <div v-else class="loading-inline">
                        <div class="spinner-small"></div>
                        <span>Loading accounts...</span>
                    </div>
                </div>
            </section>

            <!-- Repository Selector -->
            <section class="repo-selector" v-if="selectedAccount">
                <div class="selector-wrapper">
                    <label for="repo-search">Repository</label>
                    <div class="search-input-wrapper">
                        <input
                            type="text"
                            id="repo-search"
                            v-model="repoSearch"
                            @focus="showRepoDropdown = true"
                            @input="filterRepos"
                            placeholder="Search repositories..."
                            autocomplete="off"
                            :disabled="reposLoading"
                        >
                        <div class="dropdown" v-if="showRepoDropdown && filteredRepos.length > 0" @mouseleave="showRepoDropdown = false">
                            <div
                                v-for="repo in filteredRepos"
                                :key="repo.owner.login + '/' + repo.name"
                                class="dropdown-item"
                                @click="selectRepo(repo)"
                            >
                                <span class="repo-name">{{ repo.name }}</span>
                                <span class="repo-visibility" :class="{ private: repo.isPrivate }">
                                    {{ repo.isPrivate ? 'Private' : 'Public' }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div v-if="reposLoading" class="loading-inline">
                        <div class="spinner-small"></div>
                    </div>
                    <span v-if="selectedRepo" class="selected-repo-badge">
                        {{ selectedRepo.name }}
                        <button class="clear-btn" @click="clearRepo">&times;</button>
                    </span>
                    <span class="repo-count" v-if="!reposLoading && repos.length > 0">
                        {{ repos.length }} repos
                    </span>
                </div>
            </section>

            <!-- Enhanced Filter Panel -->
            <section class="filter-panel" v-if="selectedRepo">
                <div class="filter-header" @click="filtersExpanded = !filtersExpanded">
                    <h2>
                        Filters
                        <span class="filter-count" v-if="activeFiltersCount > 0">({{ activeFiltersCount }} active)</span>
                    </h2>
                    <div class="filter-header-actions">
                        <button class="btn-text" @click.stop="resetFilters" v-if="activeFiltersCount > 0">Clear all</button>
                        <span class="toggle-icon">{{ filtersExpanded ? '&#9650;' : '&#9660;' }}</span>
                    </div>
                </div>

                <div class="filter-content" v-show="filtersExpanded">
                    <!-- Filter Tabs -->
                    <div class="filter-tabs">
                        <button :class="{ active: activeFilterTab === 'basic' }" @click="activeFilterTab = 'basic'">Basic</button>
                        <button :class="{ active: activeFilterTab === 'review' }" @click="activeFilterTab = 'review'">Review</button>
                        <button :class="{ active: activeFilterTab === 'people' }" @click="activeFilterTab = 'people'">People</button>
                        <button :class="{ active: activeFilterTab === 'dates' }" @click="activeFilterTab = 'dates'">Dates</button>
                        <button :class="{ active: activeFilterTab === 'advanced' }" @click="activeFilterTab = 'advanced'">Advanced</button>
                    </div>

                    <!-- Basic Filters Tab -->
                    <div class="filter-tab-content" v-show="activeFilterTab === 'basic'">
                        <div class="filter-row">
                            <!-- State Filter -->
                            <div class="filter-group">
                                <label>State</label>
                                <div class="button-group">
                                    <button
                                        v-for="s in ['open', 'closed', 'merged', 'all']"
                                        :key="s"
                                        :class="{ active: filters.state === s }"
                                        @click="filters.state = s"
                                    >{{ s.charAt(0).toUpperCase() + s.slice(1) }}</button>
                                </div>
                            </div>

                            <!-- Draft Filter -->
                            <div class="filter-group">
                                <label>Draft Status</label>
                                <div class="button-group">
                                    <button :class="{ active: filters.draft === '' }" @click="filters.draft = ''">Any</button>
                                    <button :class="{ active: filters.draft === 'false' }" @click="filters.draft = 'false'">Ready</button>
                                    <button :class="{ active: filters.draft === 'true' }" @click="filters.draft = 'true'">Draft</button>
                                </div>
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Author Filter -->
                            <div class="filter-group">
                                <label>Author</label>
                                <select v-model="filters.author">
                                    <option value="">Any</option>
                                    <option v-for="c in contributors" :key="c" :value="c">{{ c }}</option>
                                </select>
                            </div>

                            <!-- Assignee Filter -->
                            <div class="filter-group">
                                <label>Assignee</label>
                                <select v-model="filters.assignee">
                                    <option value="">Any</option>
                                    <option v-for="c in contributors" :key="c" :value="c">{{ c }}</option>
                                </select>
                                <label class="checkbox-label">
                                    <input type="checkbox" v-model="filters.noAssignee"> No assignee
                                </label>
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Base Branch Filter -->
                            <div class="filter-group">
                                <label>Base Branch</label>
                                <select v-model="filters.base">
                                    <option value="">Any</option>
                                    <option v-for="b in branches" :key="b" :value="b">{{ b }}</option>
                                </select>
                            </div>

                            <!-- Head Branch Filter -->
                            <div class="filter-group">
                                <label>Head Branch</label>
                                <select v-model="filters.head">
                                    <option value="">Any</option>
                                    <option v-for="b in branches" :key="b" :value="b">{{ b }}</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Labels -->
                            <div class="filter-group full-width">
                                <label>Labels</label>
                                <div class="label-chips">
                                    <button
                                        v-for="l in labels"
                                        :key="l"
                                        class="label-chip"
                                        :class="{ selected: filters.labels.includes(l) }"
                                        @click="toggleLabel(l)"
                                    >{{ l }}</button>
                                </div>
                                <label class="checkbox-label" v-if="labels.length > 0">
                                    <input type="checkbox" v-model="filters.noLabel"> No labels
                                </label>
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Milestone -->
                            <div class="filter-group">
                                <label>Milestone</label>
                                <select v-model="filters.milestone">
                                    <option value="">Any</option>
                                    <option value="none">No milestone</option>
                                    <option v-for="m in milestones" :key="m.title" :value="m.title">
                                        {{ m.title }} ({{ m.state }})
                                    </option>
                                </select>
                            </div>

                            <!-- Linked to Issue -->
                            <div class="filter-group">
                                <label>Linked to Issue</label>
                                <div class="button-group">
                                    <button :class="{ active: filters.linked === '' }" @click="filters.linked = ''">Any</button>
                                    <button :class="{ active: filters.linked === 'true' }" @click="filters.linked = 'true'">Linked</button>
                                    <button :class="{ active: filters.linked === 'false' }" @click="filters.linked = 'false'">Not linked</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Review Filters Tab -->
                    <div class="filter-tab-content" v-show="activeFilterTab === 'review'">
                        <div class="filter-row">
                            <!-- Review Status (Multi-select with OR logic) -->
                            <div class="filter-group">
                                <label>Review Status <span class="filter-hint-inline">(OR logic - select multiple)</span></label>
                                <div class="multi-select-group">
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" :checked="filters.review.includes('none')" @change="toggleReview('none')">
                                        No reviews
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" :checked="filters.review.includes('required')" @change="toggleReview('required')">
                                        Review required
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" :checked="filters.review.includes('approved')" @change="toggleReview('approved')">
                                        <span class="status-indicator approved"></span> Approved
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" :checked="filters.review.includes('changes_requested')" @change="toggleReview('changes_requested')">
                                        <span class="status-indicator changes"></span> Changes requested
                                    </label>
                                </div>
                                <span class="filter-hint" v-if="filters.review.length > 1">Showing PRs matching ANY of: {{ filters.review.join(', ') }}</span>
                            </div>

                            <!-- CI/Status (Multi-select with OR logic) -->
                            <div class="filter-group">
                                <label>CI Status <span class="filter-hint-inline">(OR logic - select multiple)</span></label>
                                <div class="multi-select-group">
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" :checked="filters.status.includes('pending')" @change="toggleStatus('pending')">
                                        <span class="status-dot pending"></span> Pending
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" :checked="filters.status.includes('success')" @change="toggleStatus('success')">
                                        <span class="status-dot success"></span> Success
                                    </label>
                                    <label class="checkbox-label compact">
                                        <input type="checkbox" :checked="filters.status.includes('failure')" @change="toggleStatus('failure')">
                                        <span class="status-dot failure"></span> Failure
                                    </label>
                                </div>
                                <span class="filter-hint" v-if="filters.status.length > 1">Showing PRs matching ANY of: {{ filters.status.join(', ') }}</span>
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Reviewed By -->
                            <div class="filter-group">
                                <label>Reviewed By</label>
                                <select v-model="filters.reviewedBy">
                                    <option value="">Any</option>
                                    <option v-for="c in contributors" :key="c" :value="c">{{ c }}</option>
                                </select>
                            </div>

                            <!-- Review Requested -->
                            <div class="filter-group">
                                <label>Review Requested From</label>
                                <select v-model="filters.reviewRequested">
                                    <option value="">Any</option>
                                    <option v-for="c in contributors" :key="c" :value="c">{{ c }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- People Filters Tab -->
                    <div class="filter-tab-content" v-show="activeFilterTab === 'people'">
                        <div class="filter-row">
                            <!-- Involves -->
                            <div class="filter-group">
                                <label>Involves (author, assignee, mentions, commenter)</label>
                                <select v-model="filters.involves">
                                    <option value="">Any</option>
                                    <option v-for="c in contributors" :key="c" :value="c">{{ c }}</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Mentions -->
                            <div class="filter-group">
                                <label>Mentions</label>
                                <select v-model="filters.mentions">
                                    <option value="">Any</option>
                                    <option v-for="c in contributors" :key="c" :value="c">{{ c }}</option>
                                </select>
                            </div>

                            <!-- Commenter -->
                            <div class="filter-group">
                                <label>Commenter</label>
                                <select v-model="filters.commenter">
                                    <option value="">Any</option>
                                    <option v-for="c in contributors" :key="c" :value="c">{{ c }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Date Filters Tab -->
                    <div class="filter-tab-content" v-show="activeFilterTab === 'dates'">
                        <div class="filter-row">
                            <!-- Created -->
                            <div class="filter-group">
                                <label>Created After</label>
                                <input type="date" v-model="filters.createdAfter">
                            </div>
                            <div class="filter-group">
                                <label>Created Before</label>
                                <input type="date" v-model="filters.createdBefore">
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Updated -->
                            <div class="filter-group">
                                <label>Updated After</label>
                                <input type="date" v-model="filters.updatedAfter">
                            </div>
                            <div class="filter-group">
                                <label>Updated Before</label>
                                <input type="date" v-model="filters.updatedBefore">
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Merged -->
                            <div class="filter-group">
                                <label>Merged After</label>
                                <input type="date" v-model="filters.mergedAfter">
                            </div>
                            <div class="filter-group">
                                <label>Merged Before</label>
                                <input type="date" v-model="filters.mergedBefore">
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Closed -->
                            <div class="filter-group">
                                <label>Closed After</label>
                                <input type="date" v-model="filters.closedAfter">
                            </div>
                            <div class="filter-group">
                                <label>Closed Before</label>
                                <input type="date" v-model="filters.closedBefore">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Filters Tab -->
                    <div class="filter-tab-content" v-show="activeFilterTab === 'advanced'">
                        <div class="filter-row">
                            <!-- Text Search -->
                            <div class="filter-group full-width">
                                <label>Text Search</label>
                                <input type="text" v-model="filters.search" placeholder="Search keywords...">
                                <div class="search-in-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" :checked="filters.searchIn.includes('title')" @change="toggleSearchIn('title')"> Title
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" :checked="filters.searchIn.includes('body')" @change="toggleSearchIn('body')"> Body
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" :checked="filters.searchIn.includes('comments')" @change="toggleSearchIn('comments')"> Comments
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="filter-row">
                            <!-- Comments Count -->
                            <div class="filter-group">
                                <label>Comments Count</label>
                                <input type="text" v-model="filters.comments" placeholder="e.g., >5, >=10, 0">
                                <span class="filter-hint">Use: >n, >=n, &lt;n, &lt;=n, n</span>
                            </div>

                            <!-- Limit -->
                            <div class="filter-group">
                                <label>Results Limit</label>
                                <select v-model="filters.limit">
                                    <option :value="25">25</option>
                                    <option :value="30">30</option>
                                    <option :value="50">50</option>
                                    <option :value="100">100</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advanced Query Options Section -->
                        <div class="advanced-options-section">
                            <h4 class="section-title">Advanced Query Options</h4>
                            <p class="section-description">Enable additional GitHub search qualifiers for more precise filtering.</p>

                            <!-- Reactions Filter -->
                            <div class="advanced-option">
                                <div class="option-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" v-model="filters.advancedEnabled.reactions">
                                        <span class="toggle-text">Reactions Count</span>
                                    </label>
                                    <span class="option-hint">Filter by total reaction count on PR</span>
                                </div>
                                <div class="option-controls" v-if="filters.advancedEnabled.reactions">
                                    <select v-model="filters.reactionsOp" class="operator-select">
                                        <option value=">=">>=</option>
                                        <option value=">">></option>
                                        <option value="<="><=</option>
                                        <option value="<"><</option>
                                        <option value="=">=</option>
                                    </select>
                                    <input type="number" v-model="filters.reactionsCount" placeholder="0" min="0" class="number-input">
                                </div>
                            </div>

                            <!-- Interactions Filter -->
                            <div class="advanced-option">
                                <div class="option-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" v-model="filters.advancedEnabled.interactions">
                                        <span class="toggle-text">Interactions Count</span>
                                    </label>
                                    <span class="option-hint">Filter by reactions + comments count</span>
                                </div>
                                <div class="option-controls" v-if="filters.advancedEnabled.interactions">
                                    <select v-model="filters.interactionsOp" class="operator-select">
                                        <option value=">=">>=</option>
                                        <option value=">">></option>
                                        <option value="<="><=</option>
                                        <option value="<"><</option>
                                        <option value="=">=</option>
                                    </select>
                                    <input type="number" v-model="filters.interactionsCount" placeholder="0" min="0" class="number-input">
                                </div>
                            </div>

                            <!-- Team Review Requested -->
                            <div class="advanced-option">
                                <div class="option-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" v-model="filters.advancedEnabled.teamReview">
                                        <span class="toggle-text">Team Review Requested</span>
                                    </label>
                                    <span class="option-hint">Filter by team review request</span>
                                </div>
                                <div class="option-controls" v-if="filters.advancedEnabled.teamReview">
                                    <select v-model="filters.teamReviewRequested">
                                        <option value="">Select team...</option>
                                        <option v-for="t in teams" :key="t.slug" :value="t.slug">{{ t.name }}</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Exclude Labels -->
                            <div class="advanced-option">
                                <div class="option-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" v-model="filters.advancedEnabled.excludeLabels">
                                        <span class="toggle-text">Exclude Labels</span>
                                    </label>
                                    <span class="option-hint">Hide PRs with specific labels (NOT logic)</span>
                                </div>
                                <div class="option-controls" v-if="filters.advancedEnabled.excludeLabels">
                                    <div class="label-chips compact">
                                        <button
                                            v-for="l in labels"
                                            :key="'exclude-' + l"
                                            class="label-chip"
                                            :class="{ selected: filters.excludeLabels.includes(l) }"
                                            @click="toggleExcludeLabel(l)"
                                        >{{ l }}</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Exclude Author -->
                            <div class="advanced-option">
                                <div class="option-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" v-model="filters.advancedEnabled.excludeAuthors">
                                        <span class="toggle-text">Exclude Author</span>
                                    </label>
                                    <span class="option-hint">Hide PRs from specific author</span>
                                </div>
                                <div class="option-controls" v-if="filters.advancedEnabled.excludeAuthors">
                                    <select v-model="filters.excludeAuthor">
                                        <option value="">Select author to exclude...</option>
                                        <option v-for="c in contributors" :key="'exclude-' + c" :value="c">{{ c }}</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Exclude Milestone -->
                            <div class="advanced-option">
                                <div class="option-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" v-model="filters.advancedEnabled.excludeMilestone">
                                        <span class="toggle-text">Exclude Milestone</span>
                                    </label>
                                    <span class="option-hint">Hide PRs with specific milestone</span>
                                </div>
                                <div class="option-controls" v-if="filters.advancedEnabled.excludeMilestone">
                                    <select v-model="filters.excludeMilestone">
                                        <option value="">Select milestone to exclude...</option>
                                        <option v-for="m in milestones" :key="'exclude-' + m.title" :value="m.title">{{ m.title }}</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Sort By -->
                            <div class="advanced-option">
                                <div class="option-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" v-model="filters.advancedEnabled.sortBy">
                                        <span class="toggle-text">Custom Sort</span>
                                    </label>
                                    <span class="option-hint">Sort results by specific criteria</span>
                                </div>
                                <div class="option-controls" v-if="filters.advancedEnabled.sortBy">
                                    <select v-model="filters.sortBy">
                                        <option value="">Default</option>
                                        <option value="created">Created date</option>
                                        <option value="updated">Updated date</option>
                                        <option value="comments">Comments count</option>
                                        <option value="reactions">Reactions count</option>
                                        <option value="interactions">Interactions count</option>
                                    </select>
                                    <div class="button-group">
                                        <button :class="{ active: filters.sortDirection === 'desc' }" @click="filters.sortDirection = 'desc'">Desc</button>
                                        <button :class="{ active: filters.sortDirection === 'asc' }" @click="filters.sortDirection = 'asc'">Asc</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Apply Button -->
                    <div class="filter-actions">
                        <button class="btn-primary" @click="fetchPRs">
                            Apply Filters
                        </button>
                        <button class="btn-secondary" @click="resetFilters">Reset All</button>
                    </div>
                </div>
            </section>

            <!-- PR List / Stats Section -->
            <section class="pr-list" v-if="selectedRepo">
                <div class="list-header">
                    <div class="view-toggle">
                        <button :class="{ active: activeView === 'prs' }" @click="setActiveView('prs')">
                            Pull Requests
                            <span class="count" v-if="prs.length">({{ prs.length }})</span>
                        </button>
                        <button :class="{ active: activeView === 'stats' }" @click="setActiveView('stats')">
                            Stats
                            <span class="count" v-if="developerStats.length">({{ developerStats.length }})</span>
                        </button>
                    </div>
                    <button class="refresh-btn" @click="activeView === 'prs' ? fetchPRs() : fetchDeveloperStats()" :disabled="loading || statsLoading">
                        <span :class="{ spinning: loading || statsLoading }">&#8635;</span>
                    </button>
                </div>

                <!-- PR View -->
                <div v-if="activeView === 'prs'">
                    <div v-if="loading" class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading pull requests...</p>
                    </div>

                    <div v-else-if="error" class="error-state">
                        <p>{{ error }}</p>
                        <button @click="fetchPRs">Retry</button>
                    </div>

                    <div v-else-if="prs.length === 0" class="empty-state">
                        <p>No pull requests found matching your filters.</p>
                    </div>

                    <div v-else class="pr-cards">
                        <div
                            v-for="pr in prs"
                            :key="pr.number"
                            class="pr-card"
                            :class="[getStateClass(pr), getReviewClass(pr)]"
                        >
                            <div class="pr-card-main">
                                <div class="pr-card-content">
                                    <div class="pr-header">
                                        <span class="pr-number">#{{ pr.number }}</span>
                                        <span class="pr-state-badge" :class="getStateClass(pr)">
                                            <span class="state-icon">{{ getStateIcon(pr) }}</span>
                                            {{ getStateLabel(pr) }}
                                        </span>
                                        <span v-if="pr.isDraft" class="draft-badge">Draft</span>
                                        <!-- Review score badge -->
                                        <span
                                            v-if="hasExistingReview(pr.number)"
                                            class="review-score-badge"
                                            :class="getScoreClass(getExistingReviewScore(pr.number))"
                                            :title="getExistingReviewScore(pr.number) !== null ? `Review Score: ${getExistingReviewScore(pr.number)}/10` : 'Reviewed (no score)'"
                                        >
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="currentColor">
                                                <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/>
                                            </svg>
                                            {{ getExistingReviewScore(pr.number) !== null ? getExistingReviewScore(pr.number) : 'N/A' }}
                                        </span>
                                        <!-- New Commits badge -->
                                        <span
                                            v-if="hasNewCommits(pr.number)"
                                            class="new-commits-badge"
                                            title="New commits since last review"
                                        >
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="currentColor">
                                                <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"/>
                                            </svg>
                                            New Commits
                                        </span>
                                        <!-- Inline comments posted badge -->
                                        <span
                                            v-if="hasExistingReview(pr.number) && !canPostInlineComments(pr.number)"
                                            class="inline-posted-badge"
                                            title="Inline comments posted to GitHub"
                                        >
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="currentColor">
                                                <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                                            </svg>
                                            Posted
                                        </span>
                                    </div>
                                    <a :href="pr.url" target="_blank" class="pr-title">{{ pr.title }}</a>
                                    <div class="pr-meta">
                                        <span class="pr-author">
                                            <img v-if="pr.author?.avatarUrl" :src="pr.author.avatarUrl" :alt="pr.author.login" class="avatar">
                                            {{ pr.author?.login || 'unknown' }}
                                        </span>
                                        <span class="pr-branch">{{ pr.headRefName }} &rarr; {{ pr.baseRefName }}</span>
                                        <span class="pr-date">{{ formatDate(pr.updatedAt) }}</span>
                                    </div>
                                    <div class="pr-stats">
                                        <span class="additions">+{{ pr.additions || 0 }}</span>
                                        <span class="deletions">-{{ pr.deletions || 0 }}</span>
                                        <span class="files">{{ pr.changedFiles || 0 }} files</span>
                                    </div>
                                    <div class="pr-labels" v-if="pr.labels && pr.labels.length">
                                        <span v-for="label in pr.labels" :key="label.name" class="label" :style="{ backgroundColor: '#' + label.color }">
                                            {{ label.name }}
                                        </span>
                                    </div>
                                </div>
                                <div class="pr-card-actions">
                                    <button
                                        class="queue-btn"
                                        :class="{ 'in-queue': isInQueue(pr.number) }"
                                        @click="isInQueue(pr.number) ? removeFromQueue(pr.number, selectedRepo.owner.login + '/' + selectedRepo.name) : addToQueue(pr)"
                                        :title="isInQueue(pr.number) ? 'Remove from queue' : 'Add to merge queue'"
                                    >
                                        <svg v-if="!isInQueue(pr.number)" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"/>
                                        </svg>
                                        <svg v-else viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                                        </svg>
                                    </button>
                                    <button
                                        class="review-btn"
                                        :class="{
                                            'reviewing': getReviewStatus(pr.number) === 'running',
                                            'reviewed': getReviewStatus(pr.number) === 'completed',
                                            'review-failed': getReviewStatus(pr.number) === 'failed'
                                        }"
                                        @click="handleReviewClick(pr)"
                                        :title="getReviewStatus(pr.number) === 'running' ? 'Cancel review' : (getReviewStatus(pr.number) === 'completed' ? 'Review completed' : 'Perform code review')"
                                    >
                                        <!-- Spinner when running -->
                                        <svg v-if="getReviewStatus(pr.number) === 'running'" class="review-spinner" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M8 0a8 8 0 1 0 8 8h-1.5a6.5 6.5 0 1 1-6.5-6.5V0Z"/>
                                        </svg>
                                        <!-- Checkmark when completed -->
                                        <svg v-else-if="getReviewStatus(pr.number) === 'completed'" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                                        </svg>
                                        <!-- X mark when failed -->
                                        <svg v-else-if="getReviewStatus(pr.number) === 'failed'" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"/>
                                        </svg>
                                        <!-- Code review icon (default) -->
                                        <svg v-else viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M10.3 6.74a.75.75 0 0 1-.04 1.06l-2.908 2.646a.75.75 0 0 1-1.012 0L4.74 8.866a.75.75 0 1 1 1.02-1.102l1.09 1.008 2.4-2.182a.75.75 0 0 1 1.05.04Z"/>
                                            <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25ZM6.25 6.5a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5Zm-.75 3.75a.75.75 0 0 0 .75.75h6a.75.75 0 0 0 0-1.5h-6a.75.75 0 0 0-.75.75ZM1.5 1.75v12.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Z"/>
                                        </svg>
                                    </button>
                                    <!-- Follow-up review button (only shown if PR has existing review and new commits) -->
                                    <button
                                        v-if="hasExistingReview(pr.number) && hasNewCommits(pr.number) && getReviewStatus(pr.number) !== 'running'"
                                        class="followup-btn"
                                        @click="startFollowupReview(pr)"
                                        title="Start follow-up review (new commits detected)"
                                    >
                                        <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M8 4a4 4 0 1 1 0 8 4 4 0 0 1 0-8Zm0 1.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5Z"/>
                                            <path d="m14.95 4.636-1.414-1.414L12.121 4.636l1.414 1.414 1.415-1.414Z"/>
                                            <path d="M13.536 6.05V8h2v2h-2v2h-2v-2h-2V8h2V6.05h2Z"/>
                                        </svg>
                                    </button>
                                    <!-- Post Inline Comments button (only shown if PR has review and comments not yet posted) -->
                                    <button
                                        v-if="hasExistingReview(pr.number) && canPostInlineComments(pr.number)"
                                        class="post-inline-btn"
                                        :class="{ 'posting': isPostingInlineComments(getLatestReviewId(pr.number)) }"
                                        @click="postInlineComments(getLatestReviewId(pr.number))"
                                        :disabled="isPostingInlineComments(getLatestReviewId(pr.number))"
                                        title="Post critical issues as inline comments on GitHub"
                                    >
                                        <svg v-if="!isPostingInlineComments(getLatestReviewId(pr.number))" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M1 2.75C1 1.784 1.784 1 2.75 1h10.5c.966 0 1.75.784 1.75 1.75v7.5A1.75 1.75 0 0 1 13.25 12H9.06l-2.573 2.573A1.458 1.458 0 0 1 4 13.543V12H2.75A1.75 1.75 0 0 1 1 10.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h4.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                                            <path d="M7.75 5.25a.75.75 0 0 1 .75.75v1h1a.75.75 0 0 1 0 1.5h-1v1a.75.75 0 0 1-1.5 0v-1h-1a.75.75 0 0 1 0-1.5h1V6a.75.75 0 0 1 .75-.75Z"/>
                                        </svg>
                                        <svg v-else class="review-spinner" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M8 0a8 8 0 1 0 8 8h-1.5a6.5 6.5 0 1 1-6.5-6.5V0Z"/>
                                        </svg>
                                    </button>
                                    <button
                                        class="description-btn"
                                        @click="openDescriptionModal(pr)"
                                        :disabled="!pr.body"
                                        :title="pr.body ? 'View description' : 'No description'"
                                    >
                                        <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                            <path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats View -->
                <div v-else-if="activeView === 'stats'" class="stats-view">
                    <!-- Stats Header with Last Updated -->
                    <div class="stats-header">
                        <div class="stats-info">
                            <span class="stats-updated" v-if="statsLastUpdated">
                                Last updated: {{ formatStatsLastUpdated() }}
                                <span v-if="statsStale && !statsRefreshing" class="stale-badge">Stale</span>
                                <span v-if="statsRefreshing" class="refreshing-badge">
                                    <svg class="spinning" viewBox="0 0 16 16" width="12" height="12" fill="currentColor">
                                        <path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"/>
                                    </svg>
                                    Updating...
                                </span>
                            </span>
                        </div>
                        <button
                            class="btn-icon stats-refresh-btn"
                            @click="refreshDeveloperStats"
                            :disabled="statsLoading || statsRefreshing"
                            title="Refresh stats (fetch fresh data)"
                        >
                            <svg :class="{ 'spinning': statsLoading }" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                <path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"/>
                            </svg>
                            Refresh
                        </button>
                    </div>

                    <div v-if="statsLoading" class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading developer statistics...</p>
                    </div>

                    <div v-else-if="statsError" class="error-state">
                        <p>{{ statsError }}</p>
                        <button @click="fetchDeveloperStats">Retry</button>
                    </div>

                    <div v-else-if="sortedDeveloperStats.length === 0" class="empty-state">
                        <p>No developer statistics found for this repository.</p>
                    </div>

                    <div v-else class="stats-table-wrapper">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th class="sticky-col">Developer</th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'commits', desc: statsSortDirection === 'desc' }" @click="sortStats('commits')">
                                        Commits
                                        <span class="sort-icon">{{ statsSortBy === 'commits' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'prs_authored', desc: statsSortDirection === 'desc' }" @click="sortStats('prs_authored')">
                                        PRs
                                        <span class="sort-icon">{{ statsSortBy === 'prs_authored' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'prs_merged', desc: statsSortDirection === 'desc' }" @click="sortStats('prs_merged')">
                                        Merged
                                        <span class="sort-icon">{{ statsSortBy === 'prs_merged' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'prs_closed', desc: statsSortDirection === 'desc' }" @click="sortStats('prs_closed')">
                                        Closed
                                        <span class="sort-icon">{{ statsSortBy === 'prs_closed' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th>Merge %</th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'reviews_given', desc: statsSortDirection === 'desc' }" @click="sortStats('reviews_given')">
                                        Reviews
                                        <span class="sort-icon">{{ statsSortBy === 'reviews_given' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'approvals', desc: statsSortDirection === 'desc' }" @click="sortStats('approvals')">
                                        Approvals
                                        <span class="sort-icon">{{ statsSortBy === 'approvals' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'changes_requested', desc: statsSortDirection === 'desc' }" @click="sortStats('changes_requested')">
                                        Changes Req.
                                        <span class="sort-icon">{{ statsSortBy === 'changes_requested' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'lines_added', desc: statsSortDirection === 'desc' }" @click="sortStats('lines_added')">
                                        Lines +
                                        <span class="sort-icon">{{ statsSortBy === 'lines_added' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'lines_deleted', desc: statsSortDirection === 'desc' }" @click="sortStats('lines_deleted')">
                                        Lines -
                                        <span class="sort-icon">{{ statsSortBy === 'lines_deleted' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                    <th class="sortable" :class="{ sorted: statsSortBy === 'avg_pr_score', desc: statsSortDirection === 'desc' }" @click="sortStats('avg_pr_score')">
                                        Avg Score
                                        <span class="sort-icon">{{ statsSortBy === 'avg_pr_score' ? (statsSortDirection === 'desc' ? '' : '') : '' }}</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="dev in sortedDeveloperStats" :key="dev.login">
                                    <td class="sticky-col developer-cell">
                                        <img v-if="dev.avatar_url" :src="dev.avatar_url" :alt="dev.login" class="avatar">
                                        <span class="developer-name">{{ dev.login }}</span>
                                    </td>
                                    <td class="stat-value">{{ formatNumber(dev.commits) }}</td>
                                    <td class="stat-value">{{ dev.prs_authored }}</td>
                                    <td class="stat-value merged">{{ dev.prs_merged }}</td>
                                    <td class="stat-value closed">{{ dev.prs_closed }}</td>
                                    <td class="stat-value">
                                        <span class="merge-rate" :class="{ high: getMergeRate(dev) >= 80, medium: getMergeRate(dev) >= 50 && getMergeRate(dev) < 80, low: getMergeRate(dev) < 50 && getMergeRate(dev) > 0 }">
                                            {{ getMergeRate(dev) }}%
                                        </span>
                                    </td>
                                    <td class="stat-value">{{ dev.reviews_given }}</td>
                                    <td class="stat-value approved">{{ dev.approvals }}</td>
                                    <td class="stat-value changes">{{ dev.changes_requested }}</td>
                                    <td class="stat-value additions">{{ formatNumber(dev.lines_added) }}</td>
                                    <td class="stat-value deletions">{{ formatNumber(dev.lines_deleted) }}</td>
                                    <td class="stat-value">
                                        <span
                                            v-if="dev.avg_pr_score !== null && dev.avg_pr_score !== undefined"
                                            class="avg-score-badge"
                                            :class="getScoreClass(dev.avg_pr_score)"
                                            :title="`Based on ${dev.reviewed_pr_count || 0} reviewed PR(s)`"
                                        >
                                            {{ dev.avg_pr_score }}
                                        </span>
                                        <span v-else class="no-score">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Description Modal -->
                <div class="modal-overlay" v-if="descriptionModal.show" @click="closeDescriptionModal">
                    <div class="description-modal" @click.stop>
                        <div class="modal-header">
                            <h3>
                                <span class="pr-number">#{{ descriptionModal.pr?.number }}</span>
                                {{ descriptionModal.pr?.title }}
                            </h3>
                            <button class="modal-close-btn" @click="closeDescriptionModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="markdown-content" v-html="renderMarkdown(descriptionModal.pr?.body)"></div>
                        </div>
                    </div>
                </div>

                <!-- Review Error Modal -->
                <div class="modal-overlay" v-if="reviewErrorModal.show" @click="closeReviewErrorModal">
                    <div class="review-error-modal" @click.stop>
                        <div class="modal-header error-header">
                            <h3>
                                <span class="error-icon">&#9888;</span>
                                Review Failed
                            </h3>
                            <button class="modal-close-btn" @click="closeReviewErrorModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="error-details">
                                <div class="error-pr-info">
                                    <span class="pr-number">#{{ reviewErrorModal.prNumber }}</span>
                                    <span class="pr-title">{{ reviewErrorModal.prTitle }}</span>
                                </div>
                                <div class="error-exit-code" v-if="reviewErrorModal.exitCode !== null">
                                    Exit Code: <code>{{ reviewErrorModal.exitCode }}</code>
                                </div>
                                <div class="error-output-section">
                                    <h4>Error Output</h4>
                                    <pre class="error-output">{{ reviewErrorModal.errorOutput || 'No error details captured.' }}</pre>
                                </div>
                                <div class="error-actions">
                                    <button class="btn-primary" @click="closeReviewErrorModal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Queue Panel -->
            <div class="queue-panel-overlay" v-if="showQueuePanel" @click="closeQueuePanel">
                <div class="queue-panel" @click.stop>
                    <div class="queue-panel-header">
                        <h3>
                            Merge Queue
                            <span class="queue-count" v-if="mergeQueue.length > 0">({{ mergeQueue.length }})</span>
                        </h3>
                        <div class="queue-panel-actions">
                            <button class="btn-icon queue-refresh-btn" @click="refreshMergeQueue" :disabled="queueRefreshing" title="Refresh queue">
                                <svg :class="{ 'spinning': queueRefreshing }" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                    <path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"/>
                                </svg>
                            </button>
                            <button class="btn-text" @click="clearQueue" v-if="mergeQueue.length > 0">Clear all</button>
                            <button class="queue-close-btn" @click="closeQueuePanel">&times;</button>
                        </div>
                    </div>
                    <div class="queue-panel-body">
                        <div v-if="mergeQueue.length === 0" class="queue-empty">
                            <p>No PRs in the queue.</p>
                            <p class="queue-hint">Add PRs by clicking the queue button on any PR card.</p>
                        </div>
                        <div v-else class="queue-items">
                            <div v-for="(item, index) in mergeQueue" :key="item.number + '-' + item.repo" class="queue-item">
                                <div class="queue-item-position">{{ index + 1 }}</div>
                                <div class="queue-item-content">
                                    <div class="queue-item-header">
                                        <a :href="item.url" target="_blank" class="queue-item-title">
                                            <span class="queue-item-number">#{{ item.number }}</span>
                                            {{ item.title }}
                                        </a>
                                        <span class="pr-state-badge-small" :class="getPrStateClass(item.prState)">
                                            {{ getPrStateLabel(item.prState) }}
                                        </span>
                                        <span
                                            v-if="item.hasReview"
                                            class="review-score-badge-small"
                                            :class="getScoreClass(item.reviewScore)"
                                            :title="item.reviewScore !== null ? `Review Score: ${item.reviewScore}/10` : 'Reviewed (no score)'"
                                        >
                                            <svg viewBox="0 0 16 16" width="10" height="10" fill="currentColor">
                                                <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/>
                                            </svg>
                                            {{ item.reviewScore !== null ? item.reviewScore : 'N/A' }}
                                        </span>
                                        <span v-if="item.hasNewCommits" class="new-commits-badge-small" title="New commits since last review">
                                            New Commits
                                        </span>
                                    </div>
                                    <div class="queue-item-meta">
                                        <span class="queue-item-repo">{{ item.repo }}</span>
                                        <span class="queue-item-author">by {{ item.author }}</span>
                                        <span class="queue-item-stats">
                                            <span class="additions">+{{ item.additions }}</span>
                                            <span class="deletions">-{{ item.deletions }}</span>
                                        </span>
                                    </div>
                                    <!-- Notes Section -->
                                    <div class="queue-item-notes">
                                        <button
                                            class="notes-toggle-btn"
                                            :class="{ 'has-notes': getNotesCount(item) > 0 }"
                                            @click="toggleNotesDropdown(item)"
                                        >
                                            <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                                <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/>
                                            </svg>
                                            Notes
                                            <span v-if="getNotesCount(item) > 0" class="notes-count-badge">{{ getNotesCount(item) }}</span>
                                        </button>
                                        <button class="add-note-btn" @click="openNotesModal(item, 'add')" title="Add note">
                                            <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                                <path d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <!-- Notes Dropdown -->
                                    <div v-if="isNotesDropdownOpen(item)" class="notes-dropdown">
                                        <div v-if="notesLoading[getQueueKey(item)]" class="notes-loading">
                                            <div class="spinner-small"></div>
                                            Loading notes...
                                        </div>
                                        <div v-else-if="getItemNotes(item).length === 0" class="notes-empty">
                                            No notes yet. Click + to add one.
                                        </div>
                                        <div v-else class="notes-list">
                                            <div
                                                v-for="(note, noteIndex) in getItemNotes(item)"
                                                :key="note.id"
                                                class="note-item"
                                                :class="{ selected: selectedNoteIndex[getQueueKey(item)] === noteIndex }"
                                                @click="selectNote(item, noteIndex)"
                                            >
                                                <span class="note-preview">{{ truncateNote(note.content) }}</span>
                                                <span class="note-date">{{ formatNoteDate(note.createdAt) }}</span>
                                                <button class="note-delete-btn" @click.stop="deleteNote(note.id, item)" title="Delete note">
                                                    &times;
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Selected Note Content -->
                                        <div v-if="getSelectedNote(item)" class="note-content-preview">
                                            <div class="markdown-content" v-html="renderMarkdown(getSelectedNote(item).content)"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="queue-item-actions">
                                    <button
                                        class="queue-review-btn"
                                        :class="{
                                            'reviewing': getQueueItemReviewStatus(item) === 'running',
                                            'reviewed': getQueueItemReviewStatus(item) === 'completed',
                                            'review-failed': getQueueItemReviewStatus(item) === 'failed'
                                        }"
                                        @click="handleQueueItemReviewClick(item)"
                                        :title="getQueueItemReviewStatus(item) === 'running' ? 'Cancel review' : (getQueueItemReviewStatus(item) === 'completed' ? 'Review completed' : 'Perform code review')"
                                    >
                                        <!-- Spinner when running -->
                                        <svg v-if="getQueueItemReviewStatus(item) === 'running'" class="review-spinner" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                            <path d="M8 0a8 8 0 1 0 8 8h-1.5a6.5 6.5 0 1 1-6.5-6.5V0Z"/>
                                        </svg>
                                        <!-- Checkmark when completed -->
                                        <svg v-else-if="getQueueItemReviewStatus(item) === 'completed'" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                            <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                                        </svg>
                                        <!-- X mark when failed -->
                                        <svg v-else-if="getQueueItemReviewStatus(item) === 'failed'" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                            <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"/>
                                        </svg>
                                        <!-- Code review icon (default) -->
                                        <svg v-else viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                                            <path d="M10.3 6.74a.75.75 0 0 1-.04 1.06l-2.908 2.646a.75.75 0 0 1-1.012 0L4.74 8.866a.75.75 0 1 1 1.02-1.102l1.09 1.008 2.4-2.182a.75.75 0 0 1 1.05.04Z"/>
                                            <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25ZM6.25 6.5a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5Zm-.75 3.75a.75.75 0 0 0 .75.75h6a.75.75 0 0 0 0-1.5h-6a.75.75 0 0 0-.75.75ZM1.5 1.75v12.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Z"/>
                                        </svg>
                                    </button>
                                    <button class="queue-move-btn" @click="moveQueueItem(index, -1)" :disabled="index === 0" title="Move up">
                                        &#9650;
                                    </button>
                                    <button class="queue-move-btn" @click="moveQueueItem(index, 1)" :disabled="index === mergeQueue.length - 1" title="Move down">
                                        &#9660;
                                    </button>
                                    <button class="queue-remove-btn" @click="removeFromQueue(item.number, item.repo)" title="Remove from queue">
                                        &times;
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Modal -->
            <div class="modal-overlay" v-if="notesModal.show" @click="closeNotesModal">
                <div class="notes-modal" @click.stop>
                    <div class="modal-header">
                        <h3>
                            <span class="pr-number">#{{ notesModal.queueItem?.number }}</span>
                            {{ notesModal.mode === 'add' ? 'Add Note' : 'View Notes' }}
                        </h3>
                        <button class="modal-close-btn" @click="closeNotesModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Add Note Mode -->
                        <div v-if="notesModal.mode === 'add'" class="add-note-form">
                            <label for="note-content">Note Content (Markdown supported)</label>
                            <textarea
                                id="note-content"
                                v-model="notesModal.newNoteContent"
                                placeholder="Enter your note here... Markdown is supported."
                                rows="8"
                            ></textarea>
                            <div class="note-preview-section" v-if="notesModal.newNoteContent.trim()">
                                <h4>Preview</h4>
                                <div class="markdown-content note-preview-content" v-html="renderMarkdown(notesModal.newNoteContent)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" @click="closeNotesModal">Cancel</button>
                        <button
                            v-if="notesModal.mode === 'add'"
                            class="btn-primary"
                            @click="saveNote"
                            :disabled="!notesModal.newNoteContent.trim()"
                        >
                            Save Note
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Panel -->
            <div class="history-panel-overlay" v-if="showHistoryPanel" @click="showHistoryPanel = false">
                <div class="history-panel" @click.stop>
                    <div class="history-panel-header">
                        <h3>
                            Review History
                            <span class="history-count" v-if="reviewHistory.length > 0">({{ reviewHistory.length }})</span>
                        </h3>
                        <div class="history-panel-actions">
                            <button class="history-close-btn" @click="showHistoryPanel = false">&times;</button>
                        </div>
                    </div>
                    <div class="history-filters">
                        <input
                            type="text"
                            v-model="historyFilters.search"
                            @input="fetchReviewHistory"
                            placeholder="Search reviews..."
                            class="history-search-input"
                        >
                        <input
                            type="text"
                            v-model="historyFilters.repo"
                            @input="fetchReviewHistory"
                            placeholder="Filter by repo..."
                            class="history-filter-input"
                        >
                    </div>
                    <div class="history-panel-body">
                        <div v-if="historyLoading" class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading reviews...</p>
                        </div>
                        <div v-else-if="reviewHistory.length === 0" class="history-empty">
                            <p>No reviews found.</p>
                            <p class="history-hint">Reviews you create will appear here.</p>
                        </div>
                        <div v-else class="history-items">
                            <div v-for="review in reviewHistory" :key="review.id" class="history-item" @click="viewReviewDetail(review.id)">
                                <div class="history-item-header">
                                    <span class="history-item-number">#{{ review.pr_number }}</span>
                                    <span class="pr-state-badge-small" :class="getPrStateClass(review.pr_state)">
                                        {{ getPrStateLabel(review.pr_state) }}
                                    </span>
                                    <span
                                        class="review-score-badge"
                                        :class="getScoreClass(review.score)"
                                    >
                                        {{ review.score !== null ? review.score : 'N/A' }}
                                    </span>
                                    <span v-if="review.is_followup" class="followup-badge">Follow-up</span>
                                    <span v-if="review.inline_comments_posted" class="inline-posted-badge-small" title="Inline comments posted">
                                        <svg viewBox="0 0 16 16" width="10" height="10" fill="currentColor">
                                            <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                                        </svg>
                                    </span>
                                </div>
                                <div class="history-item-title">{{ review.pr_title || 'Untitled PR' }}</div>
                                <div class="history-item-meta">
                                    <span class="history-item-repo">{{ review.repo }}</span>
                                    <span class="history-item-date">{{ formatReviewDate(review.review_timestamp) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Viewer Modal -->
            <div class="modal-overlay" v-if="showReviewViewer" @click="closeReviewViewer">
                <div class="review-viewer-modal" @click.stop>
                    <div class="modal-header">
                        <h3>
                            <span class="pr-number">#{{ reviewViewerContent?.pr_number }}</span>
                            {{ reviewViewerContent?.pr_title || 'Code Review' }}
                        </h3>
                        <div class="modal-header-meta">
                            <span
                                class="review-score-badge large"
                                :class="getScoreClass(reviewViewerContent?.score)"
                                v-if="reviewViewerContent"
                            >
                                Score: {{ reviewViewerContent.score !== null ? reviewViewerContent.score + '/10' : 'N/A' }}
                            </span>
                            <span class="modal-date" v-if="reviewViewerContent">
                                {{ formatReviewDate(reviewViewerContent.review_timestamp) }}
                            </span>
                        </div>
                        <button class="modal-close-btn" @click="closeReviewViewer">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div v-if="reviewViewerContent" class="markdown-content" v-html="renderMarkdown(reviewViewerContent.content || '*No content available*')"></div>
                    </div>
                    <div class="modal-footer" v-if="reviewViewerContent">
                        <a
                            v-if="reviewViewerContent.pr_url"
                            :href="reviewViewerContent.pr_url"
                            target="_blank"
                            class="btn-secondary"
                        >
                            View PR on GitHub
                        </a>
                        <button class="btn-primary" @click="closeReviewViewer">Close</button>
                    </div>
                </div>
            </div>

            <!-- Welcome Message -->
            <section class="welcome" v-if="!selectedAccount">
                <div class="welcome-content">
                    <h2>Welcome to PR Explorer</h2>
                    <p>Select an account or organization above to start exploring pull requests.</p>
                    <p class="hint" v-if="accounts.length === 0 && !accountsLoading">
                        No accounts found. Make sure you're authenticated with <code>gh auth login</code>.
                    </p>
                    <div v-if="accountsLoading" class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading accounts...</p>
                    </div>
                </div>
            </section>

            <!-- Select Repo Message -->
            <section class="welcome" v-if="selectedAccount && !selectedRepo">
                <div class="welcome-content">
                    <h2>Select a Repository</h2>
                    <p>Search and select a repository from <strong>{{ selectedAccount.login }}</strong> to view pull requests.</p>
                </div>
            </section>
        </main>

        <footer class="app-footer">
            <p>Powered by GitHub CLI</p>
        </footer>
    </div>
{% endraw %}

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/marked@12.0.0/marked.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
